<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Gongfu Tea Timer</title>
	<link rel="stylesheet" href="style.css" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-title" content="Tea Timer" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>
<body>

<div id="teaSelection">
	<h1>Select tea</h1>
</div>

<div id="timerUI">
	<div class="header">
		<p id="teaNameDiv"></p>
		<p>Infusion <span id="infusionNumSpan">1</span></p>
	</div>
	<span id="timeDisplay">15:00</span>
	<p class="startButtonP"><button id="startButton">Start</button></p>
	<p id="infusionSwitcherDiv">
		<button id="prevInfusionButton">Previous</button>
		<button id="nextInfusionButton">Skip</button>
	</p>
</div>

<div id="sessionSwitcherDiv">
	<span id="sessionsDiv"></span>

	<button id="newSessionButton">New session</button>
</div>

<script>
'use strict';
var lastTime;
var timeLeft;
var timerInterval = null;
var alerted = false;

var beep1 = new Audio('audio/beep.wav');
var beep2 = new Audio('audio/done.wav');

var sessions = new Array();

var curSession = null;

var teaTypes = [
	{
		name: "Green",
		firstInfusion: 15,
		nextInfusion: +3,
		infusions: 5,
		amount: [3, 3.5],
		rinse: false,
	},
	{
		name: "Black (small leaf)",
		firstInfusion: 10,
		nextInfusion: +5,
		infusions: 8,
		amount: 4.5,
		rinse: true,
	},
	{
		name: "Black (large leaf)",
		firstInfusion: 15,
		nextInfusion: +5,
		infusions: 8,
		amount: 4,
		rinse: true,
	},
	{
		name: "White",
		firstInfusion: 20,
		nextInfusion: +5,
		infusions: 5,
		amount: [3.5, 4],
		rinse: false,
	},
	{
		name: "Yellow",
		firstInfusion: 15,
		nextInfusion: +5,
		infusions: 5,
		amount: [3.5, 4],
		rinse: false,
	},
	{
		name: "Oolong (strip)",
		firstInfusion: 20,
		nextInfusion: +5,
		infusions: 9,
		amount: [4.5, 5],
		rinse: true,
	},
	{
		name: "Oolong (ball)",
		firstInfusion: 25,
		nextInfusion: +5,
		infusions: 9,
		amount: [6, 6.5],
		rinse: true,
	},
	{
		name: "PuErh (raw)",
		firstInfusion: 10,
		nextInfusion: +3,
		infusions: 15,
		amount: 5,
		rinse: true,
	},
	{
		name: "PuErh (ripe)",
		firstInfusion: 10,
		nextInfusion: +5,
		infusions: 20,
		amount: 5,
		rinse: true,
	},
];


function StopTimer() {
	window.clearInterval(timerInterval);
	timerInterval = null;
	sessionSwitcherDiv.hidden = false;
	infusionSwitcherDiv.hidden = false;
}

function TimerTick() {
	var now = new Date();
	var elapsed = now - lastTime;
	lastTime = now;
	timeLeft -= elapsed;
	UpdateTimerDisplay();
	if (alerted == false && timeLeft <= 5000) {
		beep1.play();
		alerted = true;
	} else if (timeLeft <= 0) {
		beep2.play();
		StopTimer();
		NextInfusion();
	}
}

function SelectTea(tea) {
	curSession.infusionNum = 0;
	curSession.tea = tea;
	UpdateTea();
}

function UpdateTea() {
	timerUI.hidden = false;
	teaSelection.hidden = true;
	StartTea();
	newSessionButton.hidden = false;
	teaNameDiv.innerText = curSession.tea.name;
}

function StartTea() {
	timeLeft = (curSession.tea.firstInfusion + (curSession.tea.nextInfusion * curSession.infusionNum)) * 1000;
	infusionNumSpan.innerText = curSession.infusionNum + 1;
	UpdateTimerDisplay();
	startButton.innerText = "Start";
	startButton.className = '';
	if (curSession.infusionNum == 0)
		prevInfusionButton.style.visibility = 'hidden';
	else
		prevInfusionButton.style.visibility = 'visible';
}

function UpdateTimerDisplay() {
	timeDisplay.innerText = Math.round(timeLeft / 10);
}

function NextInfusion() {
	curSession.infusionNum++;
	StartTea();
}

function NewSession() {
	if (sessions.length == 1)
		sessionsDiv.children[sessionsDiv.children.length - 1].hidden = false;

	curSession = {
		tea: null,
		infusionNum: 0,
	}
	sessions.push(curSession);

	ShowSelectTea();
	newSessionButton.hidden = true;

	var newEl = document.createElement('button');
	newEl.innerText = sessions.length;
	(function(i) {
	newEl.onclick = function() {
		if (timerInterval == null) {
			curSession = sessions[i];
			if (curSession.tea == null) {
				ShowSelectTea();
			} else {
				UpdateTea();
			}

			for (var j = 0; j < sessionsDiv.children.length; j++) {
				if (j != i)
					sessionsDiv.children[j].className = '';
			}
			sessionsDiv.children[i].className = 'active';
		}
	};
	})(sessions.length - 1);
	if (sessions.length == 1)
		newEl.hidden = true;
	
	newEl.className = 'active';

	for (var j = 0; j < sessionsDiv.children.length; j++) {
		sessionsDiv.children[j].className = '';
	}
	sessionsDiv.appendChild(newEl);
}

function ShowSelectTea() {
	timerUI.hidden = true;
	teaSelection.hidden = false;
}



startButton.onclick = function() {
	if (timerInterval == null) {
		beep1.load();
		beep2.load();
		alerted = false;
		lastTime = new Date();
		timerInterval = window.setInterval(TimerTick, 10);
		startButton.innerText = "Stop";
		startButton.className = 'stop';
		infusionSwitcherDiv.hidden = true;
		sessionSwitcherDiv.hidden = true;
	} else {
		StopTimer();
		StartTea();
	}
}

prevInfusionButton.onclick = function() {
	if (curSession.infusionNum > 0) {
		curSession.infusionNum--;
		StartTea();
	}
}

teaNameDiv.onclick = function() {
	if (timerInterval == null) {
		ShowSelectTea();
		document.scrollingElement.scrollTop = 0;
	}
}

newSessionButton.onclick = function() {
	NewSession();
	document.scrollingElement.scrollTop = 0;
};

nextInfusionButton.onclick = NextInfusion;


for (var i in teaTypes) {
	(function(tea) {
		var newEl = document.createElement('button');
		newEl.innerText = tea.name;
		newEl.onclick = function() {
			SelectTea(tea);
		};
		teaSelection.appendChild(newEl);
	})(teaTypes[i]);
}

NewSession();

</script>
</body>
</html>